import router from '@ohos.router';
import { listScripts } from '../model/store';
import { ShortScript } from '../model/types';
import { hasOnboarded } from '../model/progress';
import { WarmTheme, WarmShadow } from './uiTheme';

interface TabEntry {
  label: string;
  idx: number;
}

interface Notification {
  id: string;
  title: string;
  content: string;
  time: string;
  read: boolean;
  type: 'new' | 'activity' | 'system';
}

@Entry
@Component
struct HomePage {
  private data: ShortScript[] = listScripts();
  private filterGroups: string[] = ['ä¸»é¢˜', 'ç±»åž‹', 'çŽ©æ³•', 'éš¾åº¦'];
  private themeOptions: string[] = ['å…¨éƒ¨', 'å¤å®…', 'éƒ½å¸‚', 'è‰ºæœ¯', 'æƒ…æ„Ÿ'];
  private genreOptions: string[] = ['å…¨éƒ¨', 'çº¿ç´¢è¿½è¸ª', 'è½»æŽ¨ç†', 'é€»è¾‘æŽ¨ç†', 'å¤šç»“å±€'];
  private playOptions: string[] = ['å…¨éƒ¨', 'å•çº¿è§£è°œ', 'æƒ…æ„Ÿ', 'æŽ¨ç†'];
  private difficultyOptions: string[] = ['å…¨éƒ¨', 'æ–°æ‰‹', 'è¿›é˜¶', 'ç¡¬æ ¸'];
  private moodOptions: string[] = ['å…¨éƒ¨', 'æƒ…æ„Ÿ', 'æŽ¨ç†', 'è‰ºæœ¯', 'éƒ½å¸‚'];
  @State keyword: string = '';
  @State moodFilter: string = 'å…¨éƒ¨';
  @State expandedFilter: string = ''; // å½“å‰å±•å¼€çš„ç­›é€‰é¡¹
  @State selectedTheme: string = 'å…¨éƒ¨';
  @State selectedGenre: string = 'å…¨éƒ¨';
  @State selectedPlay: string = 'å…¨éƒ¨';
  @State selectedDifficulty: string = 'å…¨éƒ¨';
  @State showNotifications: boolean = false;
  @State showNotificationDetail: boolean = false;
  @State selectedNotification: Notification | null = null;
  @State notifications: Notification[] = [
    {
      id: 'n1',
      title: 'æ–°å‰§æœ¬ä¸Šçº¿',
      content: 'ã€Œé™ç‰©ç”»å®¤ã€å·²è§£é”ï¼ŒæŒ‘æˆ˜è‰ºæœ¯ç³»ç¡¬æ ¸æŽ¨ç†ï¼',
      time: '10åˆ†é’Ÿå‰',
      read: false,
      type: 'new'
    },
    {
      id: 'n2',
      title: 'é™æ—¶æ´»åŠ¨',
      content: 'å®Œæˆ3ä¸ªå‰§æœ¬å³å¯è§£é”éšè—ç»“å±€ï¼Œæ´»åŠ¨å€’è®¡æ—¶3å¤©',
      time: '1å°æ—¶å‰',
      read: false,
      type: 'activity'
    },
    {
      id: 'n3',
      title: 'æ¸¸æˆæç¤º',
      content: 'è®°å¾—ä½¿ç”¨ç¬”è®°åŠŸèƒ½è®°å½•çº¿ç´¢ï¼Œå¯å¤§å¹…æå‡æŽ¨ç†æ•ˆçŽ‡',
      time: 'æ˜¨å¤©',
      read: true,
      type: 'system'
    }
  ];

  aboutToAppear() {
    if (!hasOnboarded()) {
      try { router.replaceUrl({ url: 'pages/OnboardingPage' }) } catch (_) {}
    }
  }

  private filtered(): ShortScript[] {
    return this.data.filter((s: ShortScript) => 
      this.matchKeyword(s) && 
      this.matchMood(s) &&
      this.matchTheme(s) &&
      this.matchGenre(s) &&
      this.matchPlay(s) &&
      this.matchDifficulty(s)
    );
  }

  private matchTheme(s: ShortScript): boolean {
    if (this.selectedTheme === 'å…¨éƒ¨') {
      return true;
    }
    return !!(s.tags && s.tags.some(tag => tag.includes(this.selectedTheme)));
  }

  private matchGenre(s: ShortScript): boolean {
    if (this.selectedGenre === 'å…¨éƒ¨') {
      return true;
    }
    return !!(s.tags && s.tags.some(tag => tag.includes(this.selectedGenre)));
  }

  private matchPlay(s: ShortScript): boolean {
    if (this.selectedPlay === 'å…¨éƒ¨') {
      return true;
    }
    return !!(s.tags && s.tags.some(tag => tag.includes(this.selectedPlay)));
  }

  private matchDifficulty(s: ShortScript): boolean {
    if (this.selectedDifficulty === 'å…¨éƒ¨') {
      return true;
    }
    switch (this.selectedDifficulty) {
      case 'æ–°æ‰‹':
        return s.difficulty <= 1;
      case 'è¿›é˜¶':
        return s.difficulty === 2;
      case 'ç¡¬æ ¸':
        return s.difficulty >= 3;
      default:
        return true;
    }
  }

  private matchKeyword(s: ShortScript): boolean {
    const key = this.keyword.trim();
    if (key.length === 0) {
      return true;
    }
    if (s.title.includes(key)) {
      return true;
    }
    if (s.tagline && s.tagline.includes(key)) {
      return true;
    }
    return !!(s.tags && s.tags.some(tag => tag.includes(key)));
  }

  private matchMood(s: ShortScript): boolean {
    if (this.moodFilter === 'å…¨éƒ¨') {
      return true;
    }
    return !!(s.tags && s.tags.some(tag => tag.includes(this.moodFilter)));
  }

  private difficultyLabel(d: number): string {
    if (d <= 1) return 'æ–°æ‰‹å‹å¥½';
    if (d === 2) return 'è¿›é˜¶æŒ‘æˆ˜';
    return 'ç¡¬æ ¸é€»è¾‘';
  }

  private coverColor(id: string): string {
    const palette: string[] = ['#FFE9DA', '#FEE0C6', '#FFEFD7', '#FFDACF', '#FFF2E2'];
    let hash = 0;
    for (let i = 0; i < id.length; i++) {
      hash += id.charCodeAt(i);
    }
    return palette[Math.abs(hash) % palette.length];
  }

  private toggleFilter(filterName: string) {
    if (this.expandedFilter === filterName) {
      this.expandedFilter = '';
    } else {
      this.expandedFilter = filterName;
    }
  }

  private getFilterOptions(filterName: string): string[] {
    switch (filterName) {
      case 'ä¸»é¢˜':
        return this.themeOptions;
      case 'ç±»åž‹':
        return this.genreOptions;
      case 'çŽ©æ³•':
        return this.playOptions;
      case 'éš¾åº¦':
        return this.difficultyOptions;
      default:
        return [];
    }
  }

  private getSelectedValue(filterName: string): string {
    switch (filterName) {
      case 'ä¸»é¢˜':
        return this.selectedTheme;
      case 'ç±»åž‹':
        return this.selectedGenre;
      case 'çŽ©æ³•':
        return this.selectedPlay;
      case 'éš¾åº¦':
        return this.selectedDifficulty;
      default:
        return 'å…¨éƒ¨';
    }
  }

  private selectFilterOption(filterName: string, option: string) {
    switch (filterName) {
      case 'ä¸»é¢˜':
        this.selectedTheme = option;
        break;
      case 'ç±»åž‹':
        this.selectedGenre = option;
        break;
      case 'çŽ©æ³•':
        this.selectedPlay = option;
        break;
      case 'éš¾åº¦':
        this.selectedDifficulty = option;
        break;
    }
    this.expandedFilter = '';
  }

  private getUnreadCount(): number {
    return this.notifications.filter(n => !n.read).length;
  }

  private markAsRead(notificationId: string) {
    const index = this.notifications.findIndex(n => n.id === notificationId);
    if (index !== -1) {
      this.notifications[index].read = true;
      this.notifications = this.notifications.slice();
    }
  }

  private viewNotificationDetail(notification: Notification) {
    // æ ‡è®°ä¸ºå·²è¯»
    if (!notification.read) {
      this.markAsRead(notification.id);
    }
    // æ˜¾ç¤ºè¯¦æƒ…
    this.selectedNotification = notification;
    this.showNotificationDetail = true;
  }

  private getNotificationDetailContent(notification: Notification): string {
    switch (notification.id) {
      case 'n1':
        return 'æ–°å‰§æœ¬ã€Œé™ç‰©ç”»å®¤ã€çŽ°å·²ä¸Šçº¿ï¼\n\nè¿™æ˜¯ä¸€ä¸ªè‰ºæœ¯ç³»ç¡¬æ ¸æŽ¨ç†å‰§æœ¬ï¼Œéš¾åº¦ç­‰çº§â˜…â˜…â˜…ã€‚è‘—åç»˜ç”»å¯¼å¸ˆçš„ç”»å®¤çªç„¶å°é—­ï¼Œä½ å—é‚€è¿›å…¥ç”»å®¤ï¼Œå¯»æ‰¾å¤±è¸ªçš„å­¦ç”Ÿä¸Žéšè—åœ¨ä½œå“ä¸­çš„ç•™è¨€ã€‚\n\nç‰¹è‰²çŽ©æ³•ï¼š\nâ€¢ è‰²å¡æ‹¼å›¾ï¼šä¸åŒè‰²å—å¯¹åº”å­—æ¯\nâ€¢ æš—æˆ¿åº•ç‰‡ï¼šè®°å½•å­¦ç”Ÿæƒ…ç»ª\nâ€¢ å¯¼å¸ˆæ‰‹ç¨¿ï¼šæ­ç¤ºå¸ˆç”ŸçŸ›ç›¾\n\né¢„è®¡æ¸¸çŽ©æ—¶é•¿ï¼š35åˆ†é’Ÿ\nç«‹å³å‰å¾€å‰§æœ¬åº“æŸ¥çœ‹è¯¦æƒ…å§ï¼';
      case 'n2':
        return 'é™æ—¶æ´»åŠ¨ã€ŒæŽ¨ç†è¾¾äººã€æ­£åœ¨è¿›è¡Œä¸­ï¼\n\næ´»åŠ¨æ—¶é—´ï¼šå³æ—¥èµ·è‡³3å¤©åŽ\n\næ´»åŠ¨å†…å®¹ï¼š\nå®Œæˆä»»æ„3ä¸ªå‰§æœ¬å³å¯è§£é”ç¥žç§˜éšè—ç»“å±€ã€ŒçœŸç›¸å›žå“ã€\n\næ´»åŠ¨å¥–åŠ±ï¼š\nâœ¨ ç‹¬å®¶å‰§æœ¬ç»“å±€\nðŸŽ æŽ¨ç†è¾¾äººç§°å·\nâ­ é¢å¤–æˆå°±ç‚¹æ•°\n\nå½“å‰è¿›åº¦ï¼š0/3\nå¿«åŽ»æŒ‘æˆ˜å‰§æœ¬ï¼Œè§£é”ä¸“å±žå¥–åŠ±å§ï¼';
      case 'n3':
        return 'æ¸¸æˆå°è´´å£«ï¼šå–„ç”¨ç¬”è®°åŠŸèƒ½\n\næŽ¨ç†è¿‡ç¨‹ä¸­é‡åˆ°éš¾é¢˜ï¼Ÿè¯•è¯•ä½¿ç”¨ç¬”è®°åŠŸèƒ½ï¼\n\nä½¿ç”¨æ–¹æ³•ï¼š\n1. åœ¨æ¸¸æˆä¸­ç‚¹å‡»ã€Œç¬”è®°ã€æŒ‰é’®\n2. è®°å½•å«Œç–‘äººã€åŠ¨æœºã€è¯æ®ç­‰ä¿¡æ¯\n3. æ•´ç†æ€è·¯ï¼Œä¸²è”çº¿ç´¢\n\nå°æŠ€å·§ï¼š\nâ€¢ åŠæ—¶è®°å½•é‡è¦çº¿ç´¢ï¼Œé¿å…é—å¿˜\nâ€¢ ç”¨ç¬”è®°æ¢³ç†æ—¶é—´çº¿å’Œäººç‰©å…³ç³»\nâ€¢ æ ‡è®°çŸ›ç›¾ç‚¹ï¼Œå¸®åŠ©çªç ´æŽ¨ç†ç“¶é¢ˆ\n\nä½¿ç”¨ç¬”è®°åŠŸèƒ½å¯å¤§å¹…æå‡æŽ¨ç†æ•ˆçŽ‡ï¼Œå¿«åŽ»è¯•è¯•å§ï¼';
      default:
        return notification.content;
    }
  }

  private getNotificationIcon(type: string): string {
    switch (type) {
      case 'new':
        return 'ðŸŽ‰';
      case 'activity':
        return 'ðŸŽ';
      case 'system':
        return 'ðŸ’¡';
      default:
        return 'ðŸ“¢';
    }
  }

  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        Scroll() {
        Column({ space: 0 }) {
          // é¡¶éƒ¨åŒºåŸŸ - æµ…è“ç°è‰²èƒŒæ™¯
          Column({ space: 0 }) {
            // é¡¶éƒ¨æ ‡é¢˜æ 
            Row({ space: 12 }) {
              // å·¦ä¾§å¤´åƒ - ä½¿ç”¨èƒŒæ™¯è‰²å—
              Stack({ alignContent: Alignment.Center }) {
                Text('ðŸ‘¤')
                  .fontSize(20)
              }
              .width(35)
              .height(35)
              .backgroundColor('#E5E9EC')
              .borderRadius(10)
              
              Column({ space: 2 }) {
                Text('ä½ å¥½ï¼ŒæŽ¨ç†æ—…äºº')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#1A1A1A')
                Text('ç»§ç»­åœ¨ç‹¬ç™½ä¸–ç•Œé‡Œå¯»æ‰¾çœŸç›¸')
                  .fontSize(11)
                  .fontColor('#666666')
              }
              .alignItems(HorizontalAlign.Start)
              
              Blank()
              
              // å³ä¾§é€šçŸ¥å›¾æ ‡
              Badge({
                count: this.getUnreadCount(),
                position: BadgePosition.RightTop,
                style: { badgeSize: 16, badgeColor: '#FF5A5F' }
              }) {
                Column() {
                  SymbolGlyph($r('sys.symbol.bell'))
                    .fontSize(20)
                    .fontColor(['#666666'])
                    .opacity(0.8)
                }
                .width(35)
                .height(35)
                .backgroundColor('#E5E9EC')
                .borderRadius(10)
                .justifyContent(FlexAlign.Center)
                .onClick(() => {
                  this.showNotifications = !this.showNotifications;
                })
              }
            }
            .padding({ left: 20, right: 20, top: 16, bottom: 8 })
            .width('100%')

            // ç™½è‰²æœç´¢åŒºåŸŸå®¹å™¨
            Column({ space: 0 }) {
              Row({ space: 8 }) {
                TextInput({ placeholder: 'æœç´¢å‰§æœ¬/æ ‡ç­¾/ä½œè€…' })
                  .onChange((v: string) => { this.keyword = v })
                  .layoutWeight(1)
                  .backgroundColor('rgba(223, 228, 233, 0.5)')
                  .borderRadius(15)
                  .placeholderColor('#999999')
                  .fontSize(13)
                  .padding({ left: 16, right: 16 })
                  .border({ width: 0 })
                  .height(35)
                
                // æœç´¢å›¾æ ‡
                Text('ðŸ”')
                  .fontSize(18)
                  .opacity(0.6)
              }
              .padding({ left: 6, right: 6, top: 5, bottom: 5 })
            }
            .padding({ left: 20, right: 20, top: 5, bottom: 5 })
            .backgroundColor('#FFFFFF')
            .borderRadius(10)
            .margin({ left: 20, right: 20, bottom: 8 })

            // ç­›é€‰æŒ‰é’®åŒºåŸŸ
            Stack({ alignContent: Alignment.TopStart }) {
              Row({ space: 12 }) {
                ForEach(this.filterGroups, (label: string) => {
                  Column() {
                    Text(label)
                      .fontSize(10)
                      .fontColor('#1A1A1A')
                  }
                  .height(16)
                  .padding({ left: 10, right: 10 })
                  .backgroundColor('#F9FAFB')
                  .borderRadius(6)
                  .border({ width: 0.5, color: 'rgba(128, 128, 128, 0.5)' })
                  .justifyContent(FlexAlign.Center)
                  .onClick(() => {
                    this.toggleFilter(label);
                  })
                }, (label: string) => label)
              }
              .justifyContent(FlexAlign.Center)
              .width('100%')

              if (this.expandedFilter.length > 0) {
                Column({ space: 0 }) {
                  Column({ space: 8 }) {
                    ForEach(this.getFilterOptions(this.expandedFilter), (option: string) => {
                      Text(option)
                        .fontSize(13)
                        .fontColor(this.getSelectedValue(this.expandedFilter) === option ? '#3B73FE' : '#1A1A1A')
                        .fontWeight(this.getSelectedValue(this.expandedFilter) === option ? FontWeight.Medium : FontWeight.Regular)
                        .padding({ left: 16, right: 16, top: 10, bottom: 10 })
                        .backgroundColor(this.getSelectedValue(this.expandedFilter) === option ? '#F0F5FF' : '#FFFFFF')
                        .width('100%')
                        .onClick(() => {
                          this.selectFilterOption(this.expandedFilter, option);
                        })
                    }, (option: string) => option)
                  }
                  .padding(8)
                  .backgroundColor('#FFFFFF')
                  .borderRadius(12)
                  .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.15)', offsetY: 2 })
                  .margin({ top: 25, left: 20 })
                  .width(140)
                }
              }
            }
            .width('100%')
            .height(this.expandedFilter.length > 0 ? 220 : 26)
            .margin({ bottom: 8 })
          }
          .backgroundColor('#F1F5F9')
          .padding({ bottom: 8 })

        // ä»Šæ—¥æŽ¨èåŒºåŸŸ
        Column({ space: 8 }) {
          Text('ä»Šæ—¥æŽ¨è')
            .fontSize(13)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .padding({ left: 20 })
          
          // æŽ¨èå¤§å¡ç‰‡ - å¸¦æ–‡å­—è¦†ç›–
          Stack({ alignContent: Alignment.BottomStart }) {
            Column()
              .width('100%')
              .height('100%')
              .backgroundColor('#C4B5A0')
              .borderRadius(15)
            
            Text('å†·å°å…µæ¡£æ¡ˆ')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2D2419')
              .padding({ left: 20, bottom: 16 })
          }
          .height(141)
          .borderRadius(15)
          .margin({ left: 20, right: 20 })
          .shadow({ radius: 10, color: 'rgba(0, 0, 0, 0.25)', offsetY: 5 })
        }
        .margin({ top: 8 })

        // å‰§æœ¬æ æ ‡é¢˜
        Text('å‰§æœ¬æ ')
          .fontSize(13)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .padding({ left: 20 })
          .margin({ top: 14 })

        if (this.filtered().length === 0) {
          Column({ space: 16 }) {
            Text('ðŸ˜”')
              .fontSize(48)
              .margin({ top: 50 })
            Text('æš‚æ— åŒ¹é…çš„å‰§æœ¬')
              .fontSize(16)
              .fontColor('#666666')
            Text('è¯•è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æœç´¢å…¶ä»–å…³é”®è¯')
              .fontSize(13)
              .fontColor('#999999')
              .opacity(0.7)
            Button('æ¸…é™¤æ‰€æœ‰ç­›é€‰')
              .fontSize(13)
              .backgroundColor('#E5ECF2')
              .fontColor('#1A1A1A')
              .margin({ top: 12 })
              .onClick(() => {
                this.keyword = '';
                this.selectedTheme = 'å…¨éƒ¨';
                this.selectedGenre = 'å…¨éƒ¨';
                this.selectedPlay = 'å…¨éƒ¨';
                this.selectedDifficulty = 'å…¨éƒ¨';
                this.moodFilter = 'å…¨éƒ¨';
              })
          }
          .width('100%')
          .padding({ top: 30, bottom: 60 })
          .alignItems(HorizontalAlign.Center)
        } else {
          Column({ space: 11 }) {
            ForEach(this.filtered(), (item: ShortScript) => {
              // å‰§æœ¬å¡ç‰‡ - è®¾è®¡ç¨¿æ ·å¼
              Row({ space: 12 }) {
                // å·¦ä¾§å›¾ç‰‡
                Column()
                  .width(88)
                  .height(96)
                  .backgroundColor(this.coverColor(item.id))
                  .borderRadius(15)

                // å³ä¾§ä¿¡æ¯
                Column({ space: 4 }) {
                  Row({ space: 8 }) {
                    Text(item.title)
                      .fontSize(15)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#1A1A1A')
                      .layoutWeight(1)
                    Text(item.rating ? `${item.rating.toFixed(1)}åˆ†` : 'è¯„åˆ†å¾…å®š')
                      .fontSize(11)
                      .fontColor('#3B73FE')
                  }
                  .width('100%')

                  if (item.tagline) {
                    Text(item.tagline)
                      .fontSize(11)
                      .fontColor('#666666')
                      .opacity(0.7)
                      .maxLines(1)
                  }

                  Text(`${this.difficultyLabel(item.difficulty)} Â· çº¦${item.durationMin}åˆ†é’Ÿ`)
                    .fontSize(11)
                    .fontColor('#666666')
                    .opacity(0.7)

                  Row({ space: 6 }) {
                    if (item.tags) {
                      ForEach(item.tags.slice(0, 3), (tag: string) => {
                        Text(`#${tag}`)
                          .fontSize(9)
                          .fontColor('#1A1A1A')
                          .padding({ left: 8, right: 8, top: 3, bottom: 3 })
                          .backgroundColor('#D5E0FF')
                          .borderRadius(10)
                      }, (tag: string) => tag)
                    }
                  }
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)
              }
              .padding(0)
              .width('100%')
              .height(96)
              .backgroundColor('#F9FAFB')
              .borderRadius(15)
              .border({ width: 0.5, color: 'rgba(128, 128, 128, 0.5)' })
              .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.25)', offsetY: 2 })
              .padding({ left: 0, right: 12, top: 0, bottom: 0 })
              .onClick(() => {
                try { router.pushUrl({ url: 'pages/DetailPage', params: { id: item.id } }) } catch (_) {}
              })
            }, (item: ShortScript) => item.id)
          }
          .padding({ left: 20, right: 20, bottom: 100, top: 8 })
        }
        }.padding({ bottom: 20 })
        }.scrollBar(BarState.Auto).height('100%').backgroundColor('#F1F5F9')
      }.height('100%').backgroundColor('#F1F5F9')

      // é€šçŸ¥å¼¹çª—
      if (this.showNotifications) {
        Column() {
          Column({ space: 0 }) {
            Row({ space: 12 }) {
              Text('é€šçŸ¥ä¸­å¿ƒ').fontSize(18).fontWeight(FontWeight.Medium).fontColor('#1A1A1A')
              Blank()
              Text('å…³é—­')
                .fontSize(14)
                .fontColor('#666666')
                .onClick(() => {
                  this.showNotifications = false;
                })
            }
            .padding({ left: 20, right: 20, top: 16, bottom: 12 })

            Scroll() {
              Column({ space: 1 }) {
                ForEach(this.notifications, (notification: Notification) => {
                  Column({ space: 8 }) {
                    Row({ space: 10 }) {
                      Text(this.getNotificationIcon(notification.type)).fontSize(24)
                      Column({ space: 6 }) {
                        Row({ space: 8 }) {
                          Text(notification.title)
                            .fontSize(15)
                            .fontWeight(FontWeight.Medium)
                            .fontColor('#1A1A1A')
                          if (!notification.read) {
                            Text('æœªè¯»')
                              .fontSize(10)
                              .fontColor('#FFFFFF')
                              .backgroundColor('#FF5A5F')
                              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                              .borderRadius(8)
                          }
                        }
                        Text(notification.content)
                          .fontSize(13)
                          .fontColor('#666666')
                          .maxLines(2)
                        Text(notification.time)
                          .fontSize(11)
                          .fontColor('#999999')
                      }
                      .layoutWeight(1)
                      .alignItems(HorizontalAlign.Start)
                    }
                    .padding(16)
                    .width('100%')
                  }
                  .backgroundColor(notification.read ? '#FFFFFF' : '#F0F5FF')
                  .onClick(() => {
                    this.viewNotificationDetail(notification);
                  })
                }, (notification: Notification) => notification.id)
              }
            }
            .layoutWeight(1)
          }
          .width('90%')
          .height('70%')
          .backgroundColor('#FFFFFF')
          .borderRadius(20)
          .shadow({ radius: 20, color: 'rgba(0, 0, 0, 0.25)', offsetY: 4 })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showNotifications = false;
        })
      }

      // é€šçŸ¥è¯¦æƒ…å¼¹çª—
      if (this.showNotificationDetail && this.selectedNotification) {
        Column() {
          Column({ space: 0 }) {
            Row({ space: 12 }) {
              SymbolGlyph($r('sys.symbol.chevron_left'))
                .fontSize(20)
                .fontColor(['#1A1A1A'])
                .onClick(() => {
                  this.showNotificationDetail = false;
                  this.selectedNotification = null;
                })
              Text('é€šçŸ¥è¯¦æƒ…')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor('#1A1A1A')
              Blank()
              Text('å…³é—­')
                .fontSize(14)
                .fontColor('#666666')
                .onClick(() => {
                  this.showNotificationDetail = false;
                  this.showNotifications = false;
                  this.selectedNotification = null;
                })
            }
            .padding({ left: 20, right: 20, top: 16, bottom: 12 })

            Scroll() {
              Column({ space: 20 }) {
                // æ ‡é¢˜å’Œå›¾æ ‡
                Row({ space: 12 }) {
                  Text(this.getNotificationIcon(this.selectedNotification.type))
                    .fontSize(36)
                  Column({ space: 6 }) {
                    Text(this.selectedNotification.title)
                      .fontSize(20)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#1A1A1A')
                    Text(this.selectedNotification.time)
                      .fontSize(12)
                      .fontColor('#999999')
                  }
                  .alignItems(HorizontalAlign.Start)
                }
                .padding({ left: 20, right: 20 })

                Divider()
                  .color('#EEEEEE')
                  .margin({ left: 20, right: 20 })

                // è¯¦ç»†å†…å®¹
                Text(this.getNotificationDetailContent(this.selectedNotification))
                  .fontSize(14)
                  .fontColor('#666666')
                  .lineHeight(24)
                  .padding({ left: 20, right: 20 })
              }
              .padding({ top: 12, bottom: 20 })
            }
            .layoutWeight(1)
          }
          .width('90%')
          .height('75%')
          .backgroundColor('#FFFFFF')
          .borderRadius(20)
          .shadow({ radius: 20, color: 'rgba(0, 0, 0, 0.25)', offsetY: 4 })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showNotificationDetail = false;
          this.selectedNotification = null;
        })
      }
      // åº•éƒ¨å¯¼èˆªæ 
      Row({ space: 0 }) {
        // ä¸»é¡µ
        Column({ space: 2 }) {
          SymbolGlyph($r('sys.symbol.house'))
            .fontSize(24)
            .fontColor(['#1A1A1A'])
          Text('ä¸»é¡µ')
            .fontSize(11)
            .fontColor('#1A1A1A')
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .padding({ top: 6, bottom: 6 })

        // å‰§æœ¬åº“
        Column({ space: 2 }) {
          SymbolGlyph($r('sys.symbol.book'))
            .fontSize(24)
            .fontColor(['#1A1A1A'])
          Text('å‰§æœ¬åº“')
            .fontSize(11)
            .fontColor('#1A1A1A')
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .padding({ top: 6, bottom: 6 })
        .onClick(() => {
          try { router.pushUrl({ url: 'pages/ScriptLibraryPage' }) } catch (_) {}
        })

        // ä¸‹è½½ç®¡ç†
        Column({ space: 2 }) {
          SymbolGlyph($r('sys.symbol.arrow_down_circle'))
            .fontSize(24)
            .fontColor(['#1A1A1A'])
          Text('ä¸‹è½½ç®¡ç†')
            .fontSize(11)
            .fontColor('#1A1A1A')
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .padding({ top: 6, bottom: 6 })
        .onClick(() => {
          try { router.pushUrl({ url: 'pages/DownloadPage' }) } catch (_) {}
        })

        // ä¸ªäººä¸­å¿ƒ
        Column({ space: 2 }) {
          SymbolGlyph($r('sys.symbol.person'))
            .fontSize(24)
            .fontColor(['#1A1A1A'])
          Text('ä¸ªäººä¸­å¿ƒ')
            .fontSize(11)
            .fontColor('#1A1A1A')
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .padding({ top: 6, bottom: 6 })
        .onClick(() => {
          try { router.pushUrl({ url: 'pages/ProfilePage' }) } catch (_) {}
        })
      }
      .width('100%')
      .height(48)
      .backgroundColor('#F5F5F5')
      .borderRadius(15)
      .shadow({ radius: 10, color: 'rgba(0, 0, 0, 0.25)', offsetY: 4 })
      .margin({ left: 20, right: 20, bottom: 15 })
    }
    .width('100%')
    .height('100%')
  }

}

@Preview
@Component
struct HomePreview { build() { HomePage() } }
