import router from '@ohos.router';
import { getScript } from '../model/store';
import { DetailParams } from '../model/types';
import { WarmTheme, WarmShadow } from './uiTheme';

interface CommentEntry {
  id: string;
  user: string;
  content: string;
  likes: number;
}

@Observed
class ReviewEntry {
  id: string;
  user: string;
  content: string;
  likes: number;
  liked: boolean;
  comments: CommentEntry[];

  constructor(id: string, user: string, content: string, likes: number, liked: boolean, comments: CommentEntry[]) {
    this.id = id;
    this.user = user;
    this.content = content;
    this.likes = likes;
    this.liked = liked;
    this.comments = comments;
  }
}

@Entry
@Component
struct DetailPage {
  @State sId: string = 'demo';
  @State title: string = '';
  @State difficulty: number = 0;
  @State durationMin: number = 0;
  @State intro: string = '';
  @State tagline: string = '';
  @State tags: string[] = [];
  @State mood: string = '';
  @State highlight: string = '';
  @State rating: number = 0;
  @State ratingBreakdown: number[] = [0, 0, 0];
  @State highlightCards: string[] = [];
  @State genre: string = '';
  @State coverSeed: string = 'å‰§';
  @State reviews: ReviewEntry[] = [
    new ReviewEntry('r1', 'æ™¨å…‰æ—…äºº', 'çº¿ç´¢åƒé›¨æ»´ä¸€æ ·ä¸²è”ï¼Œæœ€åä¸€æ­¥ç‰¹åˆ«æ²»æ„ˆã€‚å»ºè®®æ³¨æ„ç…¤æ²¹ç¯çš„æç¤ºï¼', 24, false, [
      { id: 'r1c1', user: 'æ‚¦æ‚¦å‘€', content: 'æ„Ÿè°¢æé†’ï¼', likes: 1 }
    ]),
    new ReviewEntry('r2', 'ç‹¬ç™½æ”¶é›†è€…', 'èŠ‚å¥å¾ˆæ¸©æŸ”ï¼Œä¸­é€”å¯ä»¥å¤šå›åˆ°ä¹¦æˆ¿æ•´ç†æ€è·¯ã€‚å¸Œæœ›æœ‰æ›´å¤šç»“å±€ã€‚', 18, false, []),
    new ReviewEntry('r3', 'åŠå¤', 'å–œæ¬¢è¿™ç§è®°å¿†ç³»å‰§æƒ…ï¼ŒèƒŒæ™¯éŸ³ä¹å†ä¸°å¯Œäº›å°±å®Œç¾äº†ã€‚', 11, false, [])
  ];
  @State showAllReviews: boolean = false;
  @State editingReviewId: string = '';
  @State commentDraft: string = '';
  @State likeStates: Map<string, boolean> = new Map([['r1', false], ['r2', false], ['r3', false]]);
  @State likeCounts: Map<string, number> = new Map([['r1', 24], ['r2', 18], ['r3', 11]]);
  @State commentLikeStates: Map<string, boolean> = new Map([['r1c1', false]]);
  @State commentLikeCounts: Map<string, number> = new Map([['r1c1', 1]]);
  @State expandedComments: Set<string> = new Set();
  @State loaded: boolean = false;

  aboutToAppear() {
    try {
      const p = router.getParams() as DetailParams | undefined;
      if (p && p.id) this.sId = p.id;
    } catch (_) {}

    const s = getScript(this.sId);
    if (s) {
      this.title = s.title;
      this.difficulty = s.difficulty;
      this.durationMin = s.durationMin;
      this.intro = s.intro;
      this.tagline = s.tagline ?? '';
      this.tags = s.tags ?? [];
      this.mood = s.mood ?? '';
      this.highlight = s.highlight ?? '';
      this.rating = s.rating ?? 8.6;
      const base = this.rating;
      this.ratingBreakdown = [
        Math.min(9.9, parseFloat((base + 0.2).toFixed(1))),
        Math.min(9.8, parseFloat((base - 0.1).toFixed(1))),
        Math.min(9.5, parseFloat((base - 0.3).toFixed(1)))
      ];
      this.highlightCards = s.highlights ? s.highlights.map((h) => `${h.title} Â· ${h.description}`) : [];
      this.genre = s.genre ?? 'æ‚¬ç–‘';
      this.coverSeed = s.title.length > 0 ? s.title.substring(0, 1) : 'å‰§';
      this.loaded = true;
    } else {
      this.title = '';
      this.difficulty = 0;
      this.durationMin = 0;
      this.intro = '';
      this.tagline = '';
      this.tags = [];
      this.mood = '';
      this.highlight = '';
      this.rating = 0;
      this.ratingBreakdown = [0, 0, 0];
      this.highlightCards = [];
      this.genre = '';
      this.coverSeed = 'å‰§';
      this.loaded = false;
    }
  }

  private difficultyLabel(): string {
    if (this.difficulty <= 1) return 'æ–°æ‰‹å‹å¥½';
    if (this.difficulty === 2) return 'è¿›é˜¶æŒ‘æˆ˜';
    return 'ç¡¬æ ¸é€»è¾‘';
  }

  private displayedReviews(): ReviewEntry[] {
    return this.showAllReviews ? this.reviews : this.reviews.slice(0, 2);
  }

  private toggleLike(reviewId: string) {
    const currentLiked = this.likeStates.get(reviewId) ?? false;
    const currentCount = this.likeCounts.get(reviewId) ?? 0;
    
    this.likeStates.set(reviewId, !currentLiked);
    this.likeCounts.set(reviewId, currentCount + (!currentLiked ? 1 : -1));
    
    // å¼ºåˆ¶è§¦å‘æ›´æ–°
    this.likeStates = new Map(this.likeStates);
    this.likeCounts = new Map(this.likeCounts);
  }

  private startComment(reviewId: string) {
    this.editingReviewId = reviewId;
    this.commentDraft = '';
  }

  private submitComment() {
    if (!this.editingReviewId || this.commentDraft.trim().length === 0) {
      return;
    }
    const text = this.commentDraft.trim();
    const index = this.reviews.findIndex((r: ReviewEntry) => r.id === this.editingReviewId);
    if (index !== -1) {
      // ç”Ÿæˆæ–°çš„è¯„è®ºID
      const newCommentId = `${this.editingReviewId}c${this.reviews[index].comments.length + 1}`;
      const newComment: CommentEntry = {
        id: newCommentId,
        user: 'å½“å‰ç”¨æˆ·',
        content: text,
        likes: 0
      };
      this.reviews[index].comments.push(newComment);
      // åˆå§‹åŒ–ç‚¹èµçŠ¶æ€
      this.commentLikeStates.set(newCommentId, false);
      this.commentLikeCounts.set(newCommentId, 0);
      // å¼ºåˆ¶è§¦å‘æ•°ç»„æ›´æ–°
      this.reviews = this.reviews.slice();
      this.commentLikeStates = new Map(this.commentLikeStates);
      this.commentLikeCounts = new Map(this.commentLikeCounts);
    }
    this.editingReviewId = '';
    this.commentDraft = '';
  }

  private cancelComment() {
    this.editingReviewId = '';
    this.commentDraft = '';
  }

  private toggleComments(reviewId: string) {
    if (this.expandedComments.has(reviewId)) {
      this.expandedComments.delete(reviewId);
    } else {
      this.expandedComments.add(reviewId);
    }
    // å¼ºåˆ¶è§¦å‘æ›´æ–°
    this.expandedComments = new Set(this.expandedComments);
  }

  private toggleCommentLike(commentId: string) {
    const currentLiked = this.commentLikeStates.get(commentId) ?? false;
    const currentCount = this.commentLikeCounts.get(commentId) ?? 0;
    
    this.commentLikeStates.set(commentId, !currentLiked);
    this.commentLikeCounts.set(commentId, currentCount + (!currentLiked ? 1 : -1));
    
    // å¼ºåˆ¶è§¦å‘æ›´æ–°
    this.commentLikeStates = new Map(this.commentLikeStates);
    this.commentLikeCounts = new Map(this.commentLikeCounts);
  }

  build() {
    Scroll() {
      Column({ space: 22 }) {
        if (!this.loaded) {
          Text('åŠ è½½ä¸­â€¦').padding(16).fontColor(WarmTheme.textPrimary)
        } else {
          Column({ space: 18 }) {
            Row({ space: 12 }) {
              Button('â—€').backgroundColor('transparent').fontColor(WarmTheme.textPrimary).onClick(() => {
                try { router.back() } catch (_) {}
              })
              Text('å‰§æœ¬è¯¦æƒ…').fontColor(WarmTheme.textSecondary).fontSize(13)
              Blank()
              Text('â€¦').fontSize(18).fontColor(WarmTheme.textSecondary)
            }.padding({ left: 20, right: 20, top: 12 })

            Column({ space: 16 }) {
              Row({ space: 18 }) {
                Column() {
                  Text(this.coverSeed).fontSize(34).fontWeight(FontWeight.Bold).fontColor(WarmTheme.textPrimary)
                }
                .width(110)
                .height(150)
                .backgroundColor('#FFE2CE')
                .borderRadius(24)
                .alignItems(HorizontalAlign.Center)
                .justifyContent(FlexAlign.Center)

                Column({ space: 10 }) {
                  Column({ space: 4 }) {
                    Text(this.title).fontSize(22).fontWeight(FontWeight.Bold).fontColor(WarmTheme.textPrimary)
                    if (this.tagline.length > 0) {
                      Text(this.tagline).fontSize(13).fontColor(WarmTheme.textSecondary)
                    }
                  }
                  Row({ space: 8 }) {
                    Text(this.genre).fontSize(12).fontColor(WarmTheme.textSecondary)
                    Text(this.difficultyLabel()).fontSize(12).fontColor(WarmTheme.textSecondary)
                    Text(`çº¦ ${this.durationMin} åˆ†é’Ÿ`).fontSize(12).fontColor(WarmTheme.textSecondary)
                  }
                  Row({ space: 6 }) {
                    ForEach(this.tags.slice(0, 4), (tag: string) => {
                      Text(tag)
                        .fontSize(11)
                        .fontColor(WarmTheme.textSecondary)
                        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                        .backgroundColor('#FFF2E5')
                        .borderRadius(12)
                    })
                  }
                }.layoutWeight(1)
              }

              Row({ space: 12 }) {
                Button('æƒ³ç©')
                  .backgroundColor('#FFE3CF')
                  .fontColor(WarmTheme.accentDark)
                  .borderRadius(20)
                  .onClick(() => {
                    try { router.pushUrl({ url: 'pages/PlayPage', params: { id: this.sId } }) } catch (_) {}
                  })
                Button('å†™æµ‹è¯„')
                  .backgroundColor('#F9E7DB')
                  .fontColor(WarmTheme.textPrimary)
                  .borderRadius(20)
                  .onClick(() => {
                    try { router.pushUrl({ url: 'pages/ReviewPage', params: { id: this.sId, title: this.title } }) } catch (_) {}
                  })
                Blank()
              }
            }
            .padding(22)
            .backgroundColor(WarmTheme.card)
            .borderRadius(32)
            .shadow(WarmShadow.card)
          }

          Column({ space: 16 }) {
            Text('ç©å®¶è¯„åˆ†').fontSize(16).fontWeight(FontWeight.Medium).fontColor(WarmTheme.textPrimary)
            Row({ space: 12 }) {
              Column({ space: 6 }) {
                Text(this.rating.toFixed(1)).fontSize(34).fontWeight(FontWeight.Bold).fontColor(WarmTheme.accentDark)
                Text('ç»¼åˆè¯„ä»·').fontSize(12).fontColor(WarmTheme.textSecondary)
                Text('åŸºäº 14466 ä½ç©å®¶ç»Ÿè®¡').fontSize(10).fontColor('#B49987')
              }
              Column({ space: 12 }) {
                ForEach(['å‰§æƒ…', 'æƒ…ç»ª', 'æ¨ç†'], (label: string, index: number) => {
                  Row({ space: 10 }) {
                    Text(label).fontSize(12).fontColor(WarmTheme.textSecondary)
                    Progress({ value: this.ratingBreakdown[index], total: 10, type: ProgressType.Linear })
                      .layoutWeight(1)
                      .height(4)
                    Text(this.ratingBreakdown[index].toFixed(1)).fontSize(12).fontColor(WarmTheme.textPrimary)
                  }
                })
              }.layoutWeight(1)
            }.padding(18).backgroundColor('#FFF2E5').borderRadius(26)
          }.padding({ left: 20, right: 20 })

          Column({ space: 12 }) {
            Text('ç”¨æˆ·è¯„ä»·').fontSize(16).fontWeight(FontWeight.Medium).fontColor(WarmTheme.textPrimary).padding({ left: 4 })
            Column({ space: 16 }) {
              ForEach(this.displayedReviews(), (review: ReviewEntry) => {
                Column({ space: 0 }) {
                  Row({ space: 12 }) {
                    Row() {
                      Text('ğŸ‘¤').fontSize(20)
                    }
                    .width(46)
                    .height(46)
                    .borderRadius(23)
                    .backgroundColor('#F5E6D9')
                    .justifyContent(FlexAlign.Center)
                    .alignItems(VerticalAlign.Center)

                    Column({ space: 12 }) {
                      Row({ space: 0 }) {
                        Text(review.user).fontSize(15).fontWeight(FontWeight.Medium).fontColor(WarmTheme.textPrimary)
                        Blank()
                      }
                      Text(review.content).fontSize(14).lineHeight(24).fontColor(WarmTheme.textSecondary)
                      Row({ space: 8 }) {
                        Text('æ˜¨å¤© 22:33').fontSize(11).fontColor('#999999')
                        Text('ç¦å»º').fontSize(11).fontColor('#999999')
                        Text('å›å¤').fontSize(11).fontColor('#999999').fontWeight(FontWeight.Medium)
                          .onClick(() => { this.startComment(review.id) })
                        Blank()
                        Column({ space: 2 }) {
                          SymbolGlyph(this.likeStates.get(review.id) ? $r('sys.symbol.heart_fill') : $r('sys.symbol.heart'))
                            .fontSize(18)
                            .fontColor([this.likeStates.get(review.id) ? '#FF5A5F' : '#999999'])
                            .onClick(() => { 
                              this.toggleLike(review.id);
                            })
                          Text(`${this.likeCounts.get(review.id) ?? 0}`)
                            .fontSize(11)
                            .fontColor('#999999')
                        }
                        .onClick(() => { 
                          this.toggleLike(review.id);
                        })
                        Text('ğŸ˜Š').fontSize(16).fontColor('#999999')
                      }
                      
                      if (review.comments.length > 0) {
                        Column({ space: 0 }) {
                          Divider().color('#EEEEEE').margin({ top: 8, bottom: 8 })
                          Text(this.expandedComments.has(review.id) ? `æ”¶èµ·å›å¤` : `å±•å¼€ ${review.comments.length} æ¡å›å¤`)
                            .fontSize(12)
                            .fontColor('#666666')
                            .onClick(() => {
                              this.toggleComments(review.id);
                            })
                        }
                      }
                      
                      if (this.expandedComments.has(review.id) && review.comments.length > 0) {
                        Column({ space: 0 }) {
                          ForEach(review.comments, (comment: CommentEntry) => {
                            Column({ space: 0 }) {
                              Row({ space: 12 }) {
                                Row() {
                                  Text('ğŸ‘¤').fontSize(20)
                                }
                                .width(46)
                                .height(46)
                                .borderRadius(23)
                                .backgroundColor('#F5E6D9')
                                .justifyContent(FlexAlign.Center)
                                .alignItems(VerticalAlign.Center)

                                Column({ space: 12 }) {
                                  Row({ space: 0 }) {
                                    Text(comment.user).fontSize(15).fontWeight(FontWeight.Medium).fontColor(WarmTheme.textPrimary)
                                    Blank()
                                  }
                                  Text(comment.content).fontSize(14).lineHeight(24).fontColor(WarmTheme.textSecondary)
                                  Row({ space: 8 }) {
                                    Text('1å°æ—¶å‰').fontSize(11).fontColor('#999999')
                                    Text('åŒ—äº¬').fontSize(11).fontColor('#999999')
                                    Text('å›å¤').fontSize(11).fontColor('#999999').fontWeight(FontWeight.Medium)
                                    Blank()
                                    Column({ space: 2 }) {
                                      SymbolGlyph((this.commentLikeStates.get(comment.id) ?? false) ? $r('sys.symbol.heart_fill') : $r('sys.symbol.heart'))
                                        .fontSize(18)
                                        .fontColor([(this.commentLikeStates.get(comment.id) ?? false) ? '#FF5A5F' : '#999999'])
                                        .onClick(() => { 
                                          this.toggleCommentLike(comment.id);
                                        })
                                      Text(`${this.commentLikeCounts.get(comment.id) ?? 0}`)
                                        .fontSize(11)
                                        .fontColor('#999999')
                                    }
                                    .onClick(() => { 
                                      this.toggleCommentLike(comment.id);
                                    })
                                    Text('ğŸ˜Š').fontSize(16).fontColor('#999999')
                                  }
                                }.layoutWeight(1).alignItems(HorizontalAlign.Start)
                              }.alignItems(VerticalAlign.Top)
                            }
                            .padding(16)
                            .backgroundColor('#FAFAFA')
                            .borderRadius(0)
                            .margin({ bottom: 1 })
                          }, (comment: CommentEntry) => comment.id)
                        }.margin({ top: 8 })
                      }
                    }.layoutWeight(1).alignItems(HorizontalAlign.Start)
                  }.alignItems(VerticalAlign.Top)

                  if (this.editingReviewId === review.id) {
                    Column({ space: 8 }) {
                      TextInput({ placeholder: 'å†™ä¸‹ä½ çš„å›åº”â€¦', text: this.commentDraft })
                        .onChange((value: string) => { this.commentDraft = value })
                        .height(80)
                        .backgroundColor('#F8F8F8')
                        .borderRadius(12)
                      Row({ space: 10 }) {
                        Button('å‘é€')
                          .type(ButtonType.Capsule)
                          .backgroundColor(WarmTheme.accent)
                          .fontColor('#FFFFFF')
                          .fontSize(12)
                          .onClick(() => { this.submitComment() })
                        Button('å–æ¶ˆ')
                          .backgroundColor('#F0F0F0')
                          .fontColor('#666666')
                          .fontSize(12)
                          .borderRadius(18)
                          .onClick(() => { this.cancelComment() })
                      }
                    }.padding({ top: 12 })
                  }
                }
                .padding(16)
                .backgroundColor('#FAFAFA')
                .borderRadius(0)
                .margin({ bottom: 1 })
              }, (review: ReviewEntry) => review.id)
            }
            Row({ space: 10 }) {
              Button(this.showAllReviews ? 'æ”¶èµ·è¯„ä»·' : 'å±•å¼€æ›´å¤š')
                .type(ButtonType.Capsule)
                .backgroundColor('#F4E6DA')
                .fontColor(WarmTheme.textPrimary)
                .fontSize(13)
                .onClick(() => { this.showAllReviews = !this.showAllReviews })
              Blank()
            }.padding({ left: 4, right: 4 })
          }.padding({ left: 20, right: 20 })

          Column({ space: 12 }) {
            Text('å‰§æƒ…ç®€ä»‹').fontSize(16).fontWeight(FontWeight.Medium).fontColor(WarmTheme.textPrimary)
            Text(this.intro).fontSize(14).lineHeight(24).fontColor(WarmTheme.textSecondary)
          }.padding({ left: 20, right: 20 })

          if (this.highlightCards.length > 0 || this.mood.length > 0 || this.highlight.length > 0) {
            Column({ space: 12 }) {
              if (this.mood.length > 0) {
                Column({ space: 6 }) {
                  Text('æ²‰æµ¸æ°›å›´').fontSize(15).fontWeight(FontWeight.Medium).fontColor(WarmTheme.textPrimary)
                  Text(this.mood).fontSize(13).fontColor(WarmTheme.textSecondary)
                }
              }
              if (this.highlight.length > 0) {
                Column({ space: 6 }) {
                  Text('äº®ç‚¹è®¾å®š').fontSize(15).fontWeight(FontWeight.Medium).fontColor(WarmTheme.textPrimary)
                  Text(this.highlight).fontSize(13).fontColor(WarmTheme.textSecondary)
                }
              }
              ForEach(this.highlightCards, (desc: string) => {
                Text(desc).fontSize(13).fontColor(WarmTheme.textSecondary).padding({ top: 6, bottom: 6 })
                  .backgroundColor('#FFF6EE').borderRadius(14).padding({ left: 12, right: 12 })
              }, (desc: string) => desc)
            }.padding({ left: 20, right: 20 }).backgroundColor(WarmTheme.card).borderRadius(26).padding({ top: 16, bottom: 16 }).shadow(WarmShadow.light)
          }

          Button('ç«‹å³å¼€å§‹æ¨ç†')
            .type(ButtonType.Capsule)
            .fontSize(16)
            .backgroundColor(WarmTheme.accent)
            .fontColor('#FFFFFF')
            .margin({ left: 20, right: 20, bottom: 36, top: 4 })
            .onClick(() => {
              try { router.pushUrl({ url: 'pages/PlayPage', params: { id: this.sId } }) } catch (_) {}
            })
        }
      }.padding({ bottom: 24 })
    }.scrollBar(BarState.Off).height('100%').backgroundColor(WarmTheme.background)
  }
} 
