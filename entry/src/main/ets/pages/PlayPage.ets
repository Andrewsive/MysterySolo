import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { getScript } from '../model/store';
import { Engine } from '../model/engine';
import { Choice, PlayParams, PlaySummary, Script } from '../model/types';
import { recordPlay } from '../model/progress';

@Entry
@Component
struct PlayPage {
  @State sid: string = 'demo';
  private eng?: Engine;
  @State sceneText: string = '';
  @State choices: Choice[] = [];
  @State scriptTitle: string = '';
  @State scriptMood: string = '';
  private script?: Script;
  @State hints: string[] = [];
  @State usedHints: number = 0;
  @State clueCount: number = 0;
  @State totalClues: number = 0;
  @State hasNewClue: boolean = false;

  aboutToAppear() {
    try {
      const p = router.getParams() as PlayParams | undefined;
      if (p && p.id) this.sid = p.id;
    } catch (_) {}
    this.script = getScript(this.sid);
    this.scriptTitle = this.script ? this.script.title : '';
    this.scriptMood = this.script && this.script.mood ? this.script.mood : '';
    this.hints = this.script && this.script.hints ? this.script.hints.map((h) => h.text) : [];
    this.totalClues = this.script && this.script.clues ? this.script.clues.length : 0;
    this.usedHints = 0;
    this.eng = this.script ? new Engine(this.script) : undefined;
    this.refreshFromEngine();
  }

  private refreshFromEngine() {
    if (!this.eng) {
      this.sceneText = 'æš‚æ— å‰§æƒ…';
      this.choices = [];
      return;
    }
    const previousClueCount = this.clueCount;
    const curScene = this.eng.current();
    this.sceneText = curScene ? curScene.text : 'æš‚æ— å‰§æƒ…';
    this.choices = curScene ? curScene.choices : [];
    this.clueCount = this.eng.getClues().length;
    
    // æ£€æµ‹æ˜¯å¦æœ‰æ–°çº¿ç´¢
    if (this.clueCount > previousClueCount) {
      this.hasNewClue = true;
      promptAction.showToast({ message: 'âœ… è·å¾—æ–°çº¿ç´¢ï¼', duration: 2000 });
      // 2ç§’åé‡ç½®æ–°çº¿ç´¢æ ‡è®°
      setTimeout(() => {
        this.hasNewClue = false;
      }, 2000);
    }
  }

  private showHint() {
    if (this.hints.length === 0) {
      promptAction.showToast({ message: 'å½“å‰å‰§æœ¬æš‚æ— æç¤º' });
      return;
    }
    const index = Math.min(this.usedHints, this.hints.length - 1);
    const content = this.hints[index];
    if (this.usedHints < this.hints.length) {
      this.usedHints += 1;
    }
    promptAction.showDialog({
      title: 'æç¤º',
      message: content,
      buttons: [{ text: 'ç»§ç»­æ¨ç†', color: '#0A84FF' }]
    });
  }

  private navigateEnding(endingId: string | undefined) {
    const ending = this.script?.endings.find((e) => e.id === endingId);
    if (this.eng && this.script && ending) {
      const summary: PlaySummary = {
        sessionId: `${this.sid}-${Date.now()}`,
        scriptId: this.sid,
        endingId: ending.id,
        score: ending.score,
        durationMin: this.script.durationMin,
        timestamp: Date.now(),
        clues: this.eng.getClues(),
        flags: this.eng.getFlags(),
        trail: this.eng.getTrail(),
        usedHints: this.usedHints
      };
      recordPlay(summary, ending.title);
    }
    try {
      router.pushUrl({ url: 'pages/ResultPage', params: { id: this.sid, endingId } });
    } catch (_) {}
  }

  build() {
    Scroll() {
      Column({ space: 16 }) {
        // é¡¶éƒ¨æ ‡é¢˜æ 
        Column({ space: 6 }) {
          Text(this.scriptTitle).fontSize(22).fontWeight(FontWeight.Bold).padding({ top: 20, left: 20, right: 20 })
          if (this.scriptMood.length > 0) {
            Text(this.scriptMood).fontSize(13).opacity(0.6).padding({ left: 20, right: 20 })
          }
        }

        // çº¿ç´¢è¿›åº¦æç¤ºå¡ç‰‡
        if (this.totalClues > 0) {
          Column({ space: 8 }) {
            Row() {
              Text('ğŸ” çº¿ç´¢è¿›åº¦').fontSize(14).fontWeight(FontWeight.Medium)
              Blank()
              Text(`${this.clueCount}/${this.totalClues}`).fontSize(14).opacity(0.7)
            }.width('100%')
            
            Progress({ value: this.clueCount, total: this.totalClues, type: ProgressType.Linear })
              .width('100%')
              .height(6)
              .borderRadius(3)
            
            if (this.hasNewClue) {
              Text('âœ¨ åˆšåˆšè·å¾—äº†æ–°çº¿ç´¢ï¼').fontSize(12).fontColor('#52C41A')
            }
          }
          .padding(16)
          .backgroundColor('#F0F9FF')
          .borderRadius(12)
          .margin({ left: 20, right: 20 })
        }

        // åŠŸèƒ½æŒ‰é’®æ 
        Column({ space: 12 }) {
          Row({ space: 8 }) {
            Button() {
              Row({ space: 4 }) {
                Text('ğŸ“‹').fontSize(16)
                Text('çº¿ç´¢ç°¿').fontSize(14)
                if (this.clueCount > 0) {
                  Text(`(${this.clueCount})`).fontSize(12).opacity(0.7)
                }
              }
            }
            .type(ButtonType.Normal)
            .backgroundColor('#E8F4FD')
            .borderRadius(12)
            .height(44)
            .layoutWeight(1)
            .onClick(() => {
              try {
                const clues = this.eng ? this.eng.getClues() : [];
                router.pushUrl({ url: 'pages/NotesPage', params: { id: this.sid, clues } })
              } catch (_) {}
            })
            
            Button() {
              Row({ space: 4 }) {
                Text('ğŸ’¡').fontSize(16)
                Text(`æç¤º`).fontSize(14)
                Text(`${this.usedHints}/${Math.max(this.hints.length, 1)}`).fontSize(12).opacity(0.7)
              }
            }
            .type(ButtonType.Normal)
            .backgroundColor('#FFF7E6')
            .borderRadius(12)
            .height(44)
            .layoutWeight(1)
            .onClick(() => {
              this.showHint();
            })
          }.width('100%')

          Button() {
            Row({ space: 4 }) {
              Text('ğŸ”„').fontSize(16)
              Text('é‡æ–°å¼€å§‹').fontSize(14)
            }
          }
          .type(ButtonType.Normal)
          .backgroundColor('#F6F7F9')
          .borderRadius(12)
          .height(44)
          .width('100%')
          .onClick(() => {
            promptAction.showDialog({
              title: 'é‡æ–°å¼€å§‹',
              message: 'ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿå½“å‰è¿›åº¦å°†ä¼šä¸¢å¤±ã€‚',
              buttons: [
                { text: 'å–æ¶ˆ', color: '#999999' },
                { text: 'ç¡®å®š', color: '#FF4D4F' }
              ]
            }).then((result) => {
              if (result.index === 1) {
                if (this.eng) {
                  this.eng.restart();
                  this.refreshFromEngine();
                }
                this.usedHints = 0;
                this.clueCount = 0;
                try { router.replaceUrl({ url: 'pages/PlayPage', params: { id: this.sid } }) } catch (_) {}
              }
            });
          })
        }.padding({ left: 20, right: 20 })

        // å‰§æƒ…æ–‡æœ¬åŒºåŸŸ
        Column() {
          Text(this.sceneText)
            .fontSize(16)
            .lineHeight(26)
            .padding({ left: 20, right: 20, top: 20, bottom: 20 })
        }
        .backgroundColor('#F6F7F9')
        .borderRadius(16)
        .margin({ left: 20, right: 20 })

        // é€‰é¡¹æç¤º
        if (this.choices.length > 0) {
          Text('ğŸ“ è¯·é€‰æ‹©ä½ çš„è¡ŒåŠ¨ï¼š')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .opacity(0.8)
            .padding({ left: 20 })
        }

        // é€‰æ‹©æŒ‰é’®
        Column({ space: 12 }) {
          ForEach(this.choices, (c: Choice, index: number) => {
            Button() {
              Row({ space: 8 }) {
                Text(`${index + 1}`).fontSize(14).opacity(0.5)
                Text(c.text).fontSize(15).layoutWeight(1).textAlign(TextAlign.Start)
                Text('â†’').fontSize(16).opacity(0.3)
              }.width('100%')
            }
            .type(ButtonType.Normal)
            .margin({ left: 20, right: 20 })
            .padding({ top: 16, bottom: 16, left: 16, right: 16 })
            .backgroundColor('#FFFFFF')
            .borderRadius(14)
            .border({ width: 1, color: '#E5E7EB' })
            .onClick(() => {
              if (!this.eng) {
                return;
              }
              const result = this.eng.choose(c);
              if (result.ended) {
                this.navigateEnding(result.endingId);
              } else {
                this.refreshFromEngine();
              }
            })
          })
        }.padding({ bottom: 20 })
      }
    }.scrollBar(BarState.Off).height('100%').backgroundColor('#FFFFFF')
  }
}

