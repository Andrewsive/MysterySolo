import router from '@ohos.router';
import { listHistory, getAchievements, getUserSettings } from '../model/progress';
import { Achievement, HistoryEntry, UserSettings } from '../model/types';

interface IdParam {
  id: string;
}

@Entry
@Component
struct ProfilePage {
  @State history: HistoryEntry[] = [];
  @State achievements: Achievement[] = [];
  @State settings: UserSettings = getUserSettings();
  private nickname: string = 'è°œå¢ƒæ—…äºº';
  private tagline: string = 'è®°å½•ä½ çš„æŽ¨ç†å±¥åŽ†ä¸Žæˆå°±';

  aboutToAppear() {
    this.history = listHistory();
    this.achievements = getAchievements();
    this.settings = getUserSettings();
  }

  build() {
    Scroll() {
      Column({ space: 20 }) {
        // å¤´éƒ¨ä¿¡æ¯
        Column({ space: 6 }) {
          Text('æˆ‘çš„').fontSize(28).fontWeight(FontWeight.Bold).fontColor('#1F1F28')
          Text(this.tagline).fontSize(13).fontColor('#787C96')
        }.padding({ left: 24, right: 24, top: 28 })

        Column({ space: 8 }) {
          Text(this.nickname).fontSize(20).fontWeight(FontWeight.Medium).fontColor('#1F1F28')
          Text('é¦–ä¸ªå‰§æœ¬å®ŒæˆäºŽ 11/13/2025').fontSize(12).fontColor('#8C8FA5')
        }.padding({ left: 24, right: 24, bottom: 8 })

        // æ¸¸çŽ©åŽ†å²
        Column({ space: 12 }) {
          Row({ space: 10 }) {
            Text('æ¸¸çŽ©åŽ†å²').fontSize(16).fontWeight(FontWeight.Medium)
            Blank()
            Button('æŸ¥çœ‹å…¨éƒ¨')
              .type(ButtonType.Capsule)
              .fontSize(12)
              .onClick(() => {
                if (this.history.length > 0) {
                  try { router.pushUrl({ url: 'pages/HistoryPage' }) } catch (_) {}
                }
              })
          }.padding({ left: 24, right: 24 })

          Column({ space: 10 }) {
            ForEach(this.history.slice(0, 3), (item: HistoryEntry) => {
              this.historyCard(item)
            }, (item: HistoryEntry) => item.sessionId)
            if (this.history.length === 0) {
              Text('æš‚æ— æ¸¸çŽ©è®°å½•ï¼ŒåŽ»ä½“éªŒä¸€ä¸ªå‰§æœ¬å§ï¼').fontSize(12).fontColor('#979BB5').padding({ left: 24, right: 24 })
            }
          }
        }

        // æˆå°±
        Column({ space: 10 }) {
          Text('æˆå°±').fontSize(16).fontWeight(FontWeight.Medium).padding({ left: 24, right: 24 })
          Row({ space: 12 }) {
            ForEach(this.achievements.slice(0, 2), (ach: Achievement) => {
              Column({ space: 4 }) {
                Text(ach.title).fontSize(13).fontWeight(FontWeight.Medium).fontColor('#1F1F28')
                Text(ach.description).fontSize(11).fontColor('#6F728C')
                Text(ach.unlocked ? 'å·²è§£é”' : `è¿›åº¦ ${ach.progress}`).fontSize(10).fontColor('#4B76FF')
              }
              .padding(14)
              .backgroundColor('#F2F4FF')
              .borderRadius(18)
            }, (ach: Achievement) => ach.id)
          }.padding({ left: 24, right: 24 })

          Button('æˆå°±å¢™')
            .type(ButtonType.Capsule)
            .fontSize(13)
            .margin({ left: 24, right: 24 })
            .onClick(() => { try { router.pushUrl({ url: 'pages/AchievementsPage' }) } catch (_) {} })
        }

        // å¿«æ·å…¥å£
        Column({ space: 10 }) {
          Text('å¿«æ·å…¥å£').fontSize(16).fontWeight(FontWeight.Medium).padding({ left: 24, right: 24 })
          Column({ space: 12 }) {
            this.quickEntry('ä¸‹è½½ç®¡ç†', () => { try { router.pushUrl({ url: 'pages/DownloadsPage' }) } catch (_) {} })
            this.quickEntry('æŽ¨ç†ç¬”è®°', () => { try { router.pushUrl({ url: 'pages/NotesPage', params: { id: 'demo' } }) } catch (_) {} })
            this.quickEntry('è®¾ç½®ä¸­å¿ƒ', () => { try { router.pushUrl({ url: 'pages/SettingsPage' }) } catch (_) {} })
          }.padding({ left: 24, right: 24 })
        }

        // æ—§èœå•å…¥å£ï¼ˆä¿æŒåŠŸèƒ½ï¼‰
        Column({ space: 14 }) {
          this.menuItem('ðŸ“’', 'Address book', 'pages/HistoryDetailPage', this.history[0]?.sessionId)
          this.menuItem('ðŸ“', 'Document management', 'pages/NotesEditorPage', 'demo')
          this.menuItem('ðŸ’¬', 'Message', 'pages/AchievementsPage', undefined, 'N')
          this.menuItem('âš™ï¸', 'Setting', 'pages/SettingsPage')
          this.menuItem('ðŸ—‘ï¸', 'Recycle bin', 'pages/DownloadsPage')
          this.menuItem('â„¹ï¸', 'Help center', 'pages/NotesPage', 'demo')
        }.padding({ left: 24, right: 24, bottom: 40 })
      }
    }.scrollBar(BarState.Off).height('100%').backgroundColor('#F9F8FB')
  }

  @Builder
  private historyCard(entry: HistoryEntry) {
    Column({ space: 6 }) {
      Text(`${entry.scriptId} Â· ${entry.endingTitle}`).fontSize(14).fontWeight(FontWeight.Medium).fontColor('#1E223A')
      Text(this.formatTime(entry.timestamp)).fontSize(11).fontColor('#8C90A8')
      Button('è¯¦æƒ…')
        .type(ButtonType.Capsule)
        .fontSize(12)
        .width('32%')
        .onClick(() => {
          try { router.pushUrl({ url: 'pages/HistoryDetailPage', params: { id: entry.sessionId } }) } catch (_) {}
        })
    }
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(18)
    .margin({ left: 24, right: 24 })
  }

  private formatTime(ts: number): string {
    const date = new Date(ts);
    return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()} ${date.toLocaleTimeString()}`;
  }

  @Builder
  private quickEntry(label: string, action: () => void) {
    Button(label)
      .type(ButtonType.Capsule)
      .fontSize(13)
      .width('100%')
      .onClick(() => { try { action() } catch (_) {} })
  }

  @Builder
  private menuItem(icon: string, label: string, url: string, param?: string, badge?: string) {
    Row({ space: 12 }) {
      Column() {
        Text(icon).fontSize(20)
      }
      .width(46)
      .height(46)
      .borderRadius(23)
      .backgroundColor('#E8EEFF')
      .alignItems(HorizontalAlign.Center)
      .justifyContent(FlexAlign.Center)

      Text(label).layoutWeight(1).fontSize(15).fontColor('#2C365E')
      if (badge) {
        Text(badge)
          .fontSize(11)
          .fontColor('#FFFFFF')
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .backgroundColor('#FF4D5A')
          .borderRadius(10)
      }
      Text('>').fontSize(14).opacity(0.4)
    }
    .padding({ left: 14, right: 14, top: 12, bottom: 12 })
    .backgroundColor('#FFFFFF')
    .borderRadius(20)
    .shadow({ radius: 6, color: '#0F000010', offsetX: 0, offsetY: 4 })
    .onClick(() => {
      try {
        if (param) {
          const paramsObj: IdParam = { id: param };
          router.pushUrl({ url, params: paramsObj });
        } else {
          router.pushUrl({ url });
        }
      } catch (_) {}
    })
  }
}

